{% extends "base.html" %}
{% block content %}
<h1>{{ folder_name }}</h1>
<p style="color: #aaa; margin-bottom: 1rem;">
    {{ photo_count }} foto's in dit album
    {% if missing_exif %}
    — <span style="color: #e94560;">{{ missing_exif }} zonder EXIF-datum</span>
    {% else %}
    — <span style="color: #4ecca3;">alle foto's hebben een EXIF-datum</span>
    {% endif %}
</p>

{% if saved %}
<div class="alert alert-success">Context opgeslagen.</div>
{% endif %}

<form method="post" action="/album/{{ album_rel }}/save">
    <div class="card">
        <h2>Albumperiode</h2>
        <div style="display: flex; gap: 1rem;">
            <div style="flex: 1;">
                <label>Startdatum</label>
                <input type="date" name="start_date" value="{{ album_data.start_date }}">
            </div>
            <div style="flex: 1;">
                <label>Einddatum</label>
                <input type="date" name="end_date" value="{{ album_data.end_date }}">
            </div>
        </div>

        <label>Extra context / beschrijving</label>
        <textarea name="context_notes" placeholder="bijv. Vakantie naar Spanje, camping bij Barcelona. Papa had net een nieuwe auto.">{{ album_data.context_notes }}</textarea>
    </div>

    <div class="card">
        <h2>IJkpunten</h2>
        <p style="color: #aaa; margin-bottom: 1rem;">
            Ken je de exacte datum van een foto? Voeg het toe als ijkpunt.
            De AI gebruikt dit om andere datums nauwkeuriger te schatten.
        </p>

        <div id="milestones">
            {% for ms in album_data.milestones %}
            <div class="milestone-row">
                <div>
                    <label>Foto #</label>
                    <input type="number" name="ms_photo_{{ loop.index0 }}" value="{{ ms.photo_index }}" min="1" max="{{ photo_count }}" style="width: 80px;">
                </div>
                <div style="flex: 1;">
                    <label>Datum</label>
                    <input type="date" name="ms_date_{{ loop.index0 }}" value="{{ ms.date }}">
                </div>
                <div style="flex: 2;">
                    <label>Beschrijving</label>
                    <input type="text" name="ms_desc_{{ loop.index0 }}" value="{{ ms.description }}" placeholder="bijv. Verjaardag papa">
                </div>
            </div>
            {% endfor %}
        </div>

        <button type="button" onclick="addMilestone()" style="margin-top: 0.5rem;" class="btn-secondary btn">+ IJkpunt toevoegen</button>
    </div>

    <div class="actions">
        <button type="submit" class="btn-secondary">Context opslaan</button>
    </div>
</form>

<form method="post" action="/album/{{ album_rel }}/analyze">
    <div class="card">
        <h2>Analyseren</h2>
        <p style="color: #aaa; margin-bottom: 1rem;">
            Start de AI-analyse. Dit schat datums op basis van visuele aanwijzingen.
        </p>

        {% if missing_exif %}
        <div style="margin-bottom: 1rem;">
            <label style="display: inline; cursor: pointer;">
                <input type="checkbox" name="only_missing" value="1" style="width: auto; margin-right: 0.5rem;">
                Alleen foto's zonder EXIF-datum ({{ missing_exif }} van {{ photo_count }})
            </label>
        </div>
        {% endif %}

        <label>Aantal foto's analyseren</label>
        <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
            <input type="number" name="limit" value="{{ photo_count }}" min="1" max="{{ photo_count }}" style="width: 100px;">
            <span style="color: #aaa;">van {{ photo_count }} foto's (begin klein om te testen)</span>
        </div>

        <button type="submit" onclick="this.disabled=true; this.textContent='Bezig met analyseren...'; this.form.submit();">
            Analyseer dit album
        </button>
    </div>
</form>

<div class="card">
    <h2>Duplicaten</h2>
    <p style="color: #aaa; margin-bottom: 1rem;">
        Zoek naar dubbele of bijna-identieke foto's in dit album.
    </p>
    <a href="/album/{{ album_rel }}/duplicates" class="btn btn-secondary"
       onclick="this.textContent='Bezig met scannen...'; this.style.pointerEvents='none';">
        Zoek duplicaten
    </a>
</div>

<div class="card">
    <h2>Organiseer in jaar/maand</h2>
    <p style="color: #aaa; margin-bottom: 1rem;">
        Verplaats foto's naar <code>YYYY/MM/</code> mappen op basis van hun EXIF-datum.
    </p>
    {% if missing_exif %}
    <p style="color: #e94560;">
        <strong>{{ missing_exif }} foto's missen een EXIF-datum.</strong>
        Analyseer eerst het album zodat alle foto's een datum hebben.
    </p>
    {% else %}
    <a href="/album/{{ album_rel }}/organize" class="btn btn-secondary">
        Bekijk voorvertoning
    </a>
    {% endif %}
</div>

<script>
let msCount = {{ album_data.milestones | length }};
function addMilestone() {
    const div = document.createElement('div');
    div.className = 'milestone-row';
    div.innerHTML = `
        <div>
            <label>Foto #</label>
            <input type="number" name="ms_photo_${msCount}" min="1" max="{{ photo_count }}" style="width: 80px;">
        </div>
        <div style="flex: 1;">
            <label>Datum</label>
            <input type="date" name="ms_date_${msCount}">
        </div>
        <div style="flex: 2;">
            <label>Beschrijving</label>
            <input type="text" name="ms_desc_${msCount}" placeholder="bijv. Verjaardag papa">
        </div>
    `;
    document.getElementById('milestones').appendChild(div);
    msCount++;
}
</script>
{% endblock %}
