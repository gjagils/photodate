{% extends "base.html" %}
{% block content %}
<h1>Organiseer albums</h1>
<p style="color: #aaa; margin-bottom: 1.5rem;">
    Verplaats foto's met EXIF-datum naar YYYY/MM mappen. Foto's zonder EXIF blijven staan.
</p>

<form method="post" action="/organize-execute" id="organizeForm">
    <div style="position: sticky; top: 0; z-index: 10; background: #1a1a2e; padding: 1rem 0; border-bottom: 1px solid #0f3460; margin-bottom: 1rem; display: none;" id="actionBar">
        <div class="actions" style="margin: 0;">
            <button type="submit" onclick="this.disabled=true; this.textContent='Bezig met verplaatsen...'; this.form.submit();">
                Verplaats geselecteerde albums
            </button>
            <span id="selectedCount" style="color: #aaa; align-self: center;"></span>
        </div>
    </div>

    <div class="card">
        <h2>Albums ({{ organizable | length }})</h2>
        {% if organizable %}
        <table>
            <thead>
                <tr>
                    <th style="width: 30px;"></th>
                    <th>Album</th>
                    <th style="text-align: right;">Met EXIF</th>
                    <th style="text-align: right;">Zonder EXIF</th>
                    <th style="width: 160px;"></th>
                </tr>
            </thead>
            <tbody>
                {% for album in organizable %}
                <tr data-album="{{ album.label }}">
                    <td>
                        <input type="checkbox"
                               class="organize-check"
                               name="albums"
                               value="{{ album.label }}"
                               onchange="updateActionBar()"
                               disabled
                               title="EXIF-data wordt geladen..."
                               style="width: 18px; height: 18px; accent-color: #4fc3f7; cursor: pointer;">
                    </td>
                    <td>
                        <a href="/album/{{ album.label }}">{{ album.label }}</a>
                    </td>
                    <td style="text-align: right;" class="exif-col">
                        <span style="color: #aaa;">…</span>
                    </td>
                    <td style="text-align: right;" class="no-exif-col">
                        <span style="color: #aaa;">…</span>
                    </td>
                    <td style="text-align: right;">
                        <button type="button"
                                class="btn-secondary"
                                style="font-size: 0.75em; padding: 0.3rem 0.6rem;"
                                onclick="toggleNever(this)">
                            nooit verplaatsen
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #aaa;">Geen albums om te organiseren.</p>
        {% endif %}
    </div>
</form>

{% if already_organized %}
<div class="card" style="opacity: 0.6;">
    <h2>Al georganiseerd ({{ already_organized | length }})</h2>
    <div class="folder-list">
        {% for album in already_organized %}
        <a href="/album/{{ album.label }}" style="display: flex; justify-content: space-between; align-items: center;">
            <span>{{ album.label }}</span>
            <span style="font-size: 0.8em; color: #aaa;">{{ album.photo_count }} foto's</span>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="card" style="opacity: 0.5; {% if not never_move %}display: none;{% endif %}" id="neverMoveCard">
    <h2 id="neverMoveTitle">Nooit verplaatsen ({{ never_move | length }})</h2>
    <table>
        <tbody id="neverMoveBody">
            {% for album in never_move %}
            <tr data-album="{{ album.label }}" data-photo-count="{{ album.photo_count }}">
                <td>
                    <a href="/album/{{ album.label }}" style="color: #aaa;">{{ album.label }}</a>
                </td>
                <td style="text-align: right; color: #aaa;">{{ album.photo_count }} foto's</td>
                <td style="text-align: right;">
                    <button type="button"
                            class="btn-secondary"
                            style="font-size: 0.75em; padding: 0.3rem 0.6rem;"
                        onclick="toggleNever(this)">
                        toch verplaatsen
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function encodePath(path) {
    return path.split('/').map(encodeURIComponent).join('/');
}

function updateActionBar() {
    const checked = document.querySelectorAll('.organize-check:checked');
    const bar = document.getElementById('actionBar');
    const count = document.getElementById('selectedCount');
    if (checked.length > 0) {
        bar.style.display = 'block';
        count.textContent = `${checked.length} album${checked.length > 1 ? 's' : ''} geselecteerd`;
    } else {
        bar.style.display = 'none';
    }
}

async function toggleNever(btn) {
    const row = btn.closest('tr');
    const albumRel = row.dataset.album;
    const isInNeverList = row.closest('#neverMoveBody');

    btn.disabled = true;
    try {
        const resp = await fetch(`/album/${encodePath(albumRel)}/toggle-never-organize`, {
            method: 'POST',
        });
        if (!resp.ok) {
            console.error(`toggleNever failed for ${albumRel}: ${resp.status} ${resp.statusText}`);
            btn.disabled = false;
            return;
        }
    } catch (e) {
        console.error(`toggleNever fetch error for ${albumRel}:`, e);
        btn.disabled = false;
        return;
    }

    const neverCard = document.getElementById('neverMoveCard');
    const neverBody = document.getElementById('neverMoveBody');
    const neverTitle = document.getElementById('neverMoveTitle');
    const albumsHeader = document.querySelector('#organizeForm .card h2');
    const albumsBody = document.querySelector('#organizeForm .card tbody');

    if (isInNeverList) {
        // Move from "nooit verplaatsen" → organizable table
        row.remove();
        const newRow = document.createElement('tr');
        newRow.dataset.album = albumRel;
        newRow.innerHTML = `
            <td>
                <input type="checkbox" class="organize-check" name="albums"
                       value="${albumRel}" onchange="updateActionBar()" disabled
                       title="EXIF-data wordt geladen..."
                       style="width: 18px; height: 18px; accent-color: #4fc3f7; cursor: pointer;">
            </td>
            <td><a href="/album/${encodePath(albumRel)}">${albumRel}</a></td>
            <td style="text-align: right;" class="exif-col"><span style="color: #aaa;">…</span></td>
            <td style="text-align: right;" class="no-exif-col"><span style="color: #aaa;">…</span></td>
            <td style="text-align: right;">
                <button type="button" class="btn-secondary"
                        style="font-size: 0.75em; padding: 0.3rem 0.6rem;"
                        onclick="toggleNever(this)">
                    nooit verplaatsen
                </button>
            </td>`;
        albumsBody.appendChild(newRow);
        // Load EXIF counts for this newly added row
        loadExifForRow(newRow);
    } else {
        // Move from organizable → "nooit verplaatsen"
        const checkbox = row.querySelector('.organize-check');
        if (checkbox?.checked) {
            checkbox.checked = false;
            updateActionBar();
        }
        row.remove();
        const newRow = document.createElement('tr');
        newRow.dataset.album = albumRel;
        newRow.innerHTML = `
            <td><a href="/album/${encodePath(albumRel)}" style="color: #aaa;">${albumRel}</a></td>
            <td style="text-align: right; color: #aaa;">&nbsp;</td>
            <td style="text-align: right;">
                <button type="button" class="btn-secondary"
                        style="font-size: 0.75em; padding: 0.3rem 0.6rem;"
                        onclick="toggleNever(this)">
                    toch verplaatsen
                </button>
            </td>`;
        neverBody.appendChild(newRow);
        neverCard.style.display = '';
    }

    // Update counts in headers
    const neverCount = neverBody.querySelectorAll('tr').length;
    neverTitle.textContent = `Nooit verplaatsen (${neverCount})`;
    if (neverCount === 0) neverCard.style.display = 'none';

    const albumCount = albumsBody ? albumsBody.querySelectorAll('tr').length : 0;
    if (albumsHeader) albumsHeader.textContent = `Albums (${albumCount})`;
}

async function loadExifForRow(row) {
    const label = row.dataset.album;
    try {
        const resp = await fetch(`/api/album/${encodePath(label)}/exif-counts`);
        if (!resp.ok) return;
        const data = await resp.json();
        const exifCol = row.querySelector('.exif-col');
        const noExifCol = row.querySelector('.no-exif-col');
        const checkbox = row.querySelector('.organize-check');
        exifCol.innerHTML = `<span style="color: #4ecca3;">${data.exif_count}</span>`
            + `<span style="color: #aaa;"> / ${data.exif_count + data.no_exif_count}</span>`;
        if (data.no_exif_count > 0) {
            noExifCol.innerHTML = `<span style="color: #f0a500;">${data.no_exif_count}</span>`;
        } else {
            noExifCol.innerHTML = `<span style="color: #aaa;">0</span>`;
        }
        if (data.exif_count > 0) {
            checkbox.disabled = false;
            checkbox.title = 'Selecteer voor organiseren';
        } else {
            checkbox.disabled = true;
            checkbox.title = "Geen foto's met EXIF";
        }
    } catch (e) {
        console.error(`Failed to load EXIF counts for ${label}:`, e);
    }
}

// Lazy load EXIF counts for all organizable rows (max 3 concurrent)
async function loadExifCounts() {
    const rows = document.querySelectorAll('#organizeForm tr[data-album]');
    const queue = [...rows];

    async function processNext() {
        while (queue.length > 0) {
            const row = queue.shift();
            await loadExifForRow(row);
        }
    }

    const workers = [];
    for (let i = 0; i < Math.min(3, queue.length); i++) {
        workers.push(processNext());
    }
    await Promise.all(workers);
}

loadExifCounts();
</script>
{% endblock %}
