{% extends "base.html" %}
{% block content %}
<h1>iCloud Verificatierapport</h1>
<p style="color: #aaa; margin-bottom: 1.5rem;">
    Controleer welke NAS-foto's ook in Google Photos staan.
    Foto's die op beide plekken staan zijn veilig om uit iCloud te verwijderen.
</p>

{% if needs_auth %}
<div class="card">
    {% if has_credentials %}
    <h2>Google Photos autorisatie nodig</h2>
    <p style="color: #aaa; margin-bottom: 1rem;">
        Je Google credentials zijn ge√ºpload. Klik hieronder om toegang te verlenen tot je Google Photos.
    </p>
    <a href="/verify/auth" class="btn">Autoriseer Google Photos</a>
    {% else %}
    <h2>Google Photos niet gekoppeld</h2>
    <p style="color: #aaa; margin-bottom: 1rem;">
        Upload eerst je Google OAuth2 credentials via
        <a href="/settings">Instellingen</a>, en autoriseer daarna.
    </p>
    <a href="/settings" class="btn btn-secondary">Naar instellingen</a>
    {% endif %}
</div>

{% else %}

<!-- Scan controls -->
<div class="card" id="scan-card">
    <h2>Scan</h2>
    <div id="scan-idle" {% if scan_running %}style="display:none"{% endif %}>
        <p style="color: #aaa; margin-bottom: 1rem;">
            Scan alle foto's op de NAS en vergelijk met Google Photos.
            Dit kan enkele minuten duren bij grote bibliotheken.
        </p>
        <button onclick="startScan()" class="btn">Start scan</button>
        {% if result %}
        <span style="color: #aaa; margin-left: 1rem; font-size: 0.85em;">Laatste resultaat beschikbaar hieronder</span>
        {% endif %}
    </div>
    <div id="scan-progress" {% if not scan_running %}style="display:none"{% endif %}>
        <p id="scan-phase" style="color: #4fc3f7; margin-bottom: 0.5rem;">Bezig...</p>
        <div style="background: #1a1a2e; border-radius: 8px; overflow: hidden; height: 24px; margin-bottom: 0.5rem;">
            <div id="scan-bar" style="background: #4fc3f7; height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; font-size: 0.8em; font-weight: bold; min-width: 30px;"></div>
        </div>
        <p id="scan-detail" style="color: #aaa; font-size: 0.85em;"></p>
    </div>
</div>

{% if result %}
<div class="card">
    <h2>Overzicht</h2>
    <div style="display: flex; gap: 2rem; margin-bottom: 1rem; flex-wrap: wrap;">
        <div>
            <p style="font-size: 2em; font-weight: bold; color: #4fc3f7;">{{ result.total }}</p>
            <p style="color: #aaa;">foto's op NAS</p>
        </div>
        <div>
            <p style="font-size: 2em; font-weight: bold; color: #4ecca3;">{{ result.total_matched }}</p>
            <p style="color: #aaa;">gevonden in Google Photos</p>
        </div>
        <div>
            <p style="font-size: 2em; font-weight: bold; color: #e94560;">{{ result.total - result.total_matched }}</p>
            <p style="color: #aaa;">NIET in Google Photos</p>
        </div>
        <div>
            <p style="font-size: 2em; font-weight: bold; color: #aaa;">{{ google_count }}</p>
            <p style="color: #aaa;">totaal in Google Photos</p>
        </div>
    </div>

    {% set pct = (result.total_matched / result.total * 100) if result.total > 0 else 0 %}
    <div style="background: #1a1a2e; border-radius: 8px; overflow: hidden; height: 30px; margin-bottom: 1rem;">
        <div style="background: #4ecca3; height: 100%; width: {{ pct }}%; display: flex; align-items: center; justify-content: center; font-weight: bold; min-width: 40px;">
            {{ "%.1f"|format(pct) }}%
        </div>
    </div>

    {% if pct == 100 %}
    <p class="success" style="font-size: 1.1em;">Alle NAS-foto's staan ook in Google Photos. Veilig om uit iCloud te verwijderen.</p>
    {% elif pct >= 90 %}
    <p class="warning" style="font-size: 1.1em;">Bijna alles gedekt. Controleer de ontbrekende foto's hieronder.</p>
    {% else %}
    <p class="error" style="font-size: 1.1em;">Niet alle foto's zijn gedekt. Verwijder NIET uit iCloud voordat je de ontbrekende foto's hebt gecontroleerd.</p>
    {% endif %}
</div>

<div class="card">
    <h2>Per jaar</h2>
    <table>
        <tr>
            <th>Jaar</th>
            <th>Foto's op NAS</th>
            <th>In Google Photos</th>
            <th>Dekking</th>
            <th>Status</th>
        </tr>
        {% for year, data in result.by_year.items() %}
        {% set year_pct = (data.matched / data.total * 100) if data.total > 0 else 0 %}
        <tr>
            <td><strong>{{ year }}</strong></td>
            <td>{{ data.total }}</td>
            <td>{{ data.matched }}</td>
            <td>{{ "%.0f"|format(year_pct) }}%</td>
            <td>
                {% if year_pct == 100 %}
                <span class="confidence-high">Volledig gedekt</span>
                {% elif year_pct >= 90 %}
                <span class="confidence-medium">Bijna gedekt</span>
                {% else %}
                <span class="confidence-low">Onvolledig</span>
                {% endif %}
            </td>
        </tr>
        {% if data.unmatched_files %}
        <tr>
            <td colspan="5" style="background: #1a1a2e; padding: 0.8rem;">
                <details>
                    <summary style="cursor: pointer; color: #e94560;">
                        {{ data.unmatched_files | length }} foto('s) NIET in Google Photos
                    </summary>
                    <ul style="margin-top: 0.5rem; color: #aaa; font-size: 0.85em;">
                        {% for fname in data.unmatched_files %}
                        <li>{{ fname }}</li>
                        {% endfor %}
                    </ul>
                </details>
            </td>
        </tr>
        {% endif %}
        {% endfor %}
    </table>
</div>
{% endif %}

<div class="actions">
    <a href="/" class="btn btn-secondary">Home</a>
</div>
{% endif %}

<script>
let polling = {{ 'true' if scan_running else 'false' }};

function startScan() {
    fetch('/verify/scan', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            if (data.ok) {
                document.getElementById('scan-idle').style.display = 'none';
                document.getElementById('scan-progress').style.display = 'block';
                polling = true;
                pollStatus();
            } else {
                alert(data.message || 'Kon scan niet starten');
            }
        });
}

function pollStatus() {
    if (!polling) return;
    fetch('/verify/status')
        .then(r => r.json())
        .then(status => {
            if (status.running) {
                const phases = {
                    'starting': 'Scan wordt gestart...',
                    'local': 'Lokale foto\'s scannen...',
                    'google': 'Google Photos ophalen...',
                    'matching': 'Foto\'s matchen...',
                };
                document.getElementById('scan-phase').textContent = phases[status.phase] || status.phase;
                document.getElementById('scan-detail').textContent = status.detail || '';
                if (status.total > 0) {
                    const pct = Math.round(status.progress / status.total * 100);
                    document.getElementById('scan-bar').style.width = pct + '%';
                    document.getElementById('scan-bar').textContent = pct + '%';
                }
                setTimeout(pollStatus, 1000);
            } else if (status.done) {
                window.location.reload();
            } else if (status.error) {
                document.getElementById('scan-phase').textContent = 'Fout: ' + status.error;
                document.getElementById('scan-phase').style.color = '#e94560';
                document.getElementById('scan-detail').textContent = '';
                polling = false;
            }
        })
        .catch(() => setTimeout(pollStatus, 2000));
}

if (polling) pollStatus();
</script>
{% endblock %}
